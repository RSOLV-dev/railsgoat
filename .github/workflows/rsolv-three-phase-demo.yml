name: RSOLV Three-Phase Security Demo (RailsGoat)

on:
  workflow_dispatch:
    inputs:
      debug:
        description: 'Enable debug logging'
        required: false
        type: boolean
        default: true
      max_issues:
        description: 'Maximum issues to process per phase'
        required: false
        type: string
        default: '2'

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  # Phase 1: SCAN - Detect vulnerabilities
  scan:
    name: "Phase 1: SCAN - Detect Vulnerabilities"
    runs-on: ubuntu-latest
    outputs:
      issues_created: ${{ steps.scan.outputs.issues_created }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: RSOLV Scan - Detect Vulnerabilities
        id: scan
        uses: RSOLV-dev/rsolv-action@v3.8.2
        with:
          rsolvApiKey: ${{ secrets.RSOLV_API_KEY }}
          api_url: https://rsolv-staging.com
          mode: 'scan'
          max_issues: 10 # Process up to 10 issues to demonstrate full capability
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          DEBUG: ${{ inputs.debug && 'rsolv:*' || '' }}
          RSOLV_TESTING_MODE: 'true'  # RFC-059: Enable testing mode for known vulnerable repo

      - name: Scan Results Summary
        run: |
          echo "âœ… Phase 1: SCAN Complete"
          echo "Issues created: ${{ steps.scan.outputs.issues_created }}"
          echo "Check the Issues tab for vulnerabilities with 'rsolv:detected' label"
          echo ""
          echo "Expected RailsGoat vulnerabilities:"
          echo "- Mass assignment issues"
          echo "- SQL injection"
          echo "- XSS vulnerabilities"
          echo "- CSRF issues"
          echo "- Authentication/authorization problems"

  # Phase 2: VALIDATE - Validate vulnerabilities using AST analysis
  validate:
    name: "Phase 2: VALIDATE - AST Validation"
    runs-on: ubuntu-latest
    needs: scan
    if: needs.scan.result == 'success'
    outputs:
      validated_count: ${{ steps.validate.outputs.validated_count }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: RSOLV Validate - AST Analysis
        id: validate
        uses: RSOLV-dev/rsolv-action@v3.8.2
        with:
          rsolvApiKey: ${{ secrets.RSOLV_API_KEY }}
          api_url: https://rsolv-staging.com
          mode: 'validate'
          issue_label: 'rsolv:detected'
          max_issues: 10 # Process up to 10 issues to demonstrate full capability
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          DEBUG: ${{ inputs.debug && 'rsolv:*' || '' }}
          LOG_LEVEL: 'debug'  # Enable debug logging for AI response analysis
          RSOLV_TESTING_MODE: 'true'  # RFC-059: Enable testing mode

      - name: Validation Results Summary
        run: |
          echo "âœ… Phase 2: VALIDATE Complete"
          echo "Validated issues: ${{ steps.validate.outputs.validated_count }}"
          echo ""
          echo "AST validation helps ensure:"
          echo "- Real vulnerabilities (not false positives)"
          echo "- Accurate vulnerability categorization"
          echo "- Ruby/Rails-specific pattern matching"
          echo ""
          echo "Check issue labels:"
          echo "- 'rsolv:validated' = confirmed vulnerability"
          echo "- 'rsolv:false-positive' = closed as not a real issue"

  # Phase 3: MITIGATE - Generate fixes using Claude Code
  mitigate:
    name: "Phase 3: MITIGATE - Generate Fixes"
    runs-on: ubuntu-latest
    needs: [scan, validate]
    if: needs.scan.result == 'success' && needs.validate.result == 'success'
    outputs:
      prs_created: ${{ steps.mitigate.outputs.prs_created }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Git for PR Creation
        run: |
          git config --global user.name "RSOLV Bot"
          git config --global user.email "bot@rsolv.dev"

      - name: RSOLV Mitigate - Generate Fixes
        id: mitigate
        uses: RSOLV-dev/rsolv-action@v3.8.2
        with:
          rsolvApiKey: ${{ secrets.RSOLV_API_KEY }}
          api_url: https://rsolv-staging.com
          mode: 'mitigate'
          issue_label: 'rsolv:validated'
          max_issues: 10 # Process up to 10 issues to demonstrate full capability
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          DEBUG: ${{ inputs.debug && 'rsolv:*' || '' }}
          RSOLV_TESTING_MODE: 'true'  # RFC-059: Enable testing mode

      - name: Mitigation Results Summary
        run: |
          echo "âœ… Phase 3: MITIGATE Complete"
          echo "Pull requests created: ${{ steps.mitigate.outputs.prs_created }}"
          echo ""
          echo "Generated fixes include:"
          echo "- RSpec test files (test-first approach)"
          echo "- Rails-specific security improvements"
          echo "- Proper ActiveRecord patterns"
          echo "- Strong parameters for mass assignment"
          echo ""
          echo "Check the Pull Requests tab for fix proposals"

  # Final Summary
  summary:
    name: "Demo Complete Summary"
    runs-on: ubuntu-latest
    needs: [scan, validate, mitigate]
    if: always()
    steps:
      - name: Generate Demo Summary
        run: |
          echo "ðŸŽ‰ RSOLV Three-Phase Security Demo Complete (RailsGoat)!"
          echo ""
          echo "## Results Summary:"
          echo ""
          echo "### Phase 1: SCAN"
          echo "- Status: ${{ needs.scan.result }}"
          echo "- Issues Created: ${{ needs.scan.outputs.issues_created || 'N/A' }}"
          echo ""
          echo "### Phase 2: VALIDATE"
          echo "- Status: ${{ needs.validate.result }}"
          echo "- Validated Count: ${{ needs.validate.outputs.validated_count || 'N/A' }}"
          echo "- Description: AST validation for Ruby/Rails code"
          echo ""
          echo "### Phase 3: MITIGATE"
          echo "- Status: ${{ needs.mitigate.result }}"
          echo "- PRs Created: ${{ needs.mitigate.outputs.prs_created || 'N/A' }}"
          echo "- Description: Rails-specific fixes with RSpec tests"
          echo ""
          echo "## RailsGoat Test Results:"
          echo "- Language: Ruby (Rails framework)"
          echo "- Test Framework: RSpec (expected)"
          echo "- Security Patterns: Rails-specific (ActiveRecord, strong params, etc.)"
          echo ""
          echo "## Next Steps:"
          echo "1. Review created issues in the Issues tab"
          echo "2. Check validation results (AST analysis comments)"
          echo "3. Review and merge pull requests with fixes"
          echo "4. Compare with NodeGoat results for multi-language validation"
          echo ""
          echo "## Marketplace Readiness:"
          echo "- âœ… Three-phase workflow demonstrated"
          echo "- âœ… Ruby/Rails language support validated"
          echo "- âœ… Framework-specific fixes generated"
          echo "- âœ… Test-first approach (RSpec tests)"
          echo ""
          echo "## Screenshots Captured:"
          echo "- [ ] Workflow execution view"
          echo "- [ ] Created issues with 'rsolv:detected' labels"
          echo "- [ ] AST validation results in issue comments"
          echo "- [ ] Pull requests with Rails-specific fixes"
          echo "- [ ] RSpec test files in PR diff"
          echo "- [ ] CI checks passing (if applicable)"
